async function f(n){if(!navigator.gpu)return null;const e=await navigator.gpu.requestAdapter();if(!e)return null;const i=await e.requestDevice(),s=n.getContext("webgpu");if(!s)return null;const r=navigator.gpu.getPreferredCanvasFormat();return s.configure({device:i,format:r,alphaMode:"premultiplied"}),{device:i,context:s,format:r}}function v(n,e=Math.min(window.devicePixelRatio,2)){const i=n.getBoundingClientRect();n.width=Math.round(i.width*e),n.height=Math.round(i.height*e)}function p(n,e){return n.replace(/^#import\s+(\w+)/gm,(i,s)=>s in e?e[s]:(console.warn(`[WGSL] Unresolved #import: ${s}`),`/* unresolved #import ${s} */`))}function w(n,e,i){const s=i?p(e,i):e,r=n.createShaderModule({code:s});return r.getCompilationInfo().then(a=>{for(const o of a.messages){const c=o.type==="error"?"error":"warn";console[c](`[WGSL ${o.type}] ${o.message}`)}}),r}class L{state={x:0,y:0,active:!1,button:0};cleanup=null;constructor(e){const i=(t,m)=>{const l=e.getBoundingClientRect();this.state.x=(t-l.left)/l.width,this.state.y=(m-l.top)/l.height},s=t=>i(t.clientX,t.clientY),r=t=>{t.preventDefault(),this.state.active=!0,this.state.button=t.button},a=()=>{this.state.active=!1},o=()=>{this.state.active=!1},c=t=>t.preventDefault(),h=t=>{t.preventDefault(),this.state.active=!0,this.state.button=t.touches.length>1?2:0,t.touches.length>0&&i(t.touches[0].clientX,t.touches[0].clientY)},d=t=>{t.preventDefault(),t.touches.length>0&&i(t.touches[0].clientX,t.touches[0].clientY)},u=t=>{t.touches.length===0?this.state.active=!1:this.state.button=t.touches.length>1?2:0};e.addEventListener("mousemove",s),e.addEventListener("mousedown",r),e.addEventListener("mouseup",a),e.addEventListener("mouseleave",o),e.addEventListener("contextmenu",c),e.addEventListener("touchstart",h,{passive:!1}),e.addEventListener("touchmove",d,{passive:!1}),e.addEventListener("touchend",u),e.addEventListener("touchcancel",u),this.cleanup=()=>{e.removeEventListener("mousemove",s),e.removeEventListener("mousedown",r),e.removeEventListener("mouseup",a),e.removeEventListener("mouseleave",o),e.removeEventListener("contextmenu",c),e.removeEventListener("touchstart",h),e.removeEventListener("touchmove",d),e.removeEventListener("touchend",u),e.removeEventListener("touchcancel",u)}}destroy(){this.cleanup?.(),this.cleanup=null}}function g(n,e,i,s){const r=n.beginRenderPass({colorAttachments:[{view:e,clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});r.setPipeline(i),r.setBindGroup(0,s),r.draw(3),r.end()}class S{canvas;cellSize;interval;device;ctx;format;gw=0;gh=0;renderPL;renderBG;raf=null;last=0;resizeTimer=null;constructor(e){this.canvas=e.canvas,this.cellSize=e.cellSize,this.interval=e.updateInterval}async start(){try{v(this.canvas);const e=await f(this.canvas);return e?(this.device=e.device,this.ctx=e.context,this.format=e.format,this.device.lost.then(i=>{console.warn(`[${this.constructor.name}] Device lost (${i.reason}): ${i.message}`),this.stop()}),this.gw=Math.ceil(this.canvas.width/this.cellSize),this.gh=Math.ceil(this.canvas.height/this.cellSize),this.buildPipelines(),this.buildResources(),this.onStart(),this.renderFrame(),this.raf=requestAnimationFrame(this.loop),!0):!1}catch(e){return console.warn(`[${this.constructor.name}] Init failed:`,e),!1}}stop(){this.raf!==null&&cancelAnimationFrame(this.raf),this.raf=null,this.resizeTimer!==null&&clearTimeout(this.resizeTimer),this.resizeTimer=null,this.onStop()}handleResize(){this.resizeTimer!==null&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(()=>this.rebuild(),150)}rebuild(){v(this.canvas),this.ctx.configure({device:this.device,format:this.format,alphaMode:"premultiplied"}),this.gw=Math.ceil(this.canvas.width/this.cellSize),this.gh=Math.ceil(this.canvas.height/this.cellSize),this.destroyResources(),this.buildResources(),this.renderFrame()}renderFrame(){const e=this.device.createCommandEncoder();g(e,this.ctx.getCurrentTexture().createView(),this.renderPL,this.renderBG),this.device.queue.submit([e.finish()])}loop=e=>{this.raf=requestAnimationFrame(this.loop),!(e-this.last<this.interval)&&(this.last=e,this.frame())};onStart(){}onStop(){}}const E=`struct VSOut {
  @builtin(position) pos: vec4f,
  @location(0) uv: vec2f,
};

@vertex
fn vert(@builtin(vertex_index) i: u32) -> VSOut {
  let p = array(vec2f(-1, -1), vec2f(3, -1), vec2f(-1, 3));
  var o: VSOut;
  o.pos = vec4f(p[i], 0, 1);
  o.uv = p[i] * 0.5 + 0.5;
  return o;
}
`;export{L as M,S as W,E as a,w as c,g as f};
